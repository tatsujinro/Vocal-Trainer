<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>å‰ä»–æ‰‹å°ˆå±¬è²æ¨‚æ•™ç·´</title>
    <style>
        :root {
            --bg-color: #1a1a1a;
            --card-bg: #2d2d2d;
            --text-main: #e0e0e0;
            --accent: #4CAF50;
            --accent-hover: #45a049;
            --highlight: #ff9800;
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--bg-color);
            color: var(--text-main);
            margin: 0;
            padding: 20px;
            text-align: center;
        }
        h1 { font-size: 1.5rem; margin-bottom: 5px; color: var(--accent); }
        p.subtitle { font-size: 0.9rem; color: #aaa; margin-bottom: 20px; }
        
        .control-panel {
            background: var(--card-bg);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.3);
        }

        label { display: block; margin: 10px 0 5px; font-size: 0.9rem; text-align: left; }
        input[type="range"] { width: 100%; height: 6px; background: #555; border-radius: 5px; outline: none; -webkit-appearance: none; }
        input[type="range"]::-webkit-slider-thumb { -webkit-appearance: none; width: 20px; height: 20px; background: var(--accent); border-radius: 50%; cursor: pointer; }

        .tabs { display: flex; justify-content: center; gap: 5px; margin-bottom: 20px; }
        .tab-btn {
            background: #444; border: none; color: #ccc; padding: 10px 15px; border-radius: 8px; font-size: 0.9rem; cursor: pointer; flex: 1;
        }
        .tab-btn.active { background: var(--accent); color: white; font-weight: bold; }

        .action-area { margin-top: 20px; }
        .play-btn {
            background: var(--accent); color: white; border: none; padding: 15px 40px; border-radius: 50px; font-size: 1.2rem; cursor: pointer; width: 100%; max-width: 300px;
            box-shadow: 0 4px 10px rgba(76, 175, 80, 0.4); transition: transform 0.1s;
        }
        .play-btn:active { transform: scale(0.95); }
        .stop-btn { background: #d32f2f; margin-top: 10px; display: none; }

        .status-display {
            margin-top: 20px; height: 60px; display: flex; flex-direction: column; justify-content: center; align-items: center;
        }
        .current-note { font-size: 2rem; font-weight: bold; color: var(--highlight); }
        .current-action { font-size: 1rem; color: #888; }
        
        .setup-row { display: flex; gap: 10px; justify-content: space-between; }
        select { background: #444; color: white; border: none; padding: 5px; border-radius: 5px; width: 100%; font-size: 1rem; }
    </style>
</head>
<body>

    <h1>ğŸ¸ å‰ä»–æ‰‹è²æ¨‚æ•™ç·´</h1>
    <p class="subtitle">C2# - G5# å°ˆå±¬éŸ³æº–é–‹å—“å·¥å…·</p>

    <div class="tabs">
        <button class="tab-btn active" onclick="setMode('liptrill')">ğŸ‘„ å”‡é¡«éŸ³</button>
        <button class="tab-btn" onclick="setMode('expansion')">ğŸ“¢ æ¯éŸ³æ“´å¼µ</button>
        <button class="tab-btn" onclick="setMode('jumps')">ğŸ“ˆ å…«åº¦è·³èº</button>
    </div>

    <div class="control-panel">
        <div class="setup-row">
            <div style="flex:1; margin-right:5px;">
                <label>èµ·å§‹æ ¹éŸ³ (ä½)</label>
                <select id="startNote"></select>
            </div>
            <div style="flex:1; margin-left:5px;">
                <label>é ‚é»æ ¹éŸ³ (é«˜)</label>
                <select id="endNote"></select>
            </div>
        </div>

        <label>æ’­æ”¾é€Ÿåº¦: <span id="speedVal">0.75</span>x</label>
        <input type="range" id="speed" min="0.5" max="1.5" step="0.05" value="0.75" oninput="updateDisplay()">

        <label>å°å¼•éŸ³é‡ (Melody)</label>
        <input type="range" id="volMelody" min="0" max="1" step="0.1" value="0.8">

        <label>ä¼´å¥éŸ³é‡ (Chord)</label>
        <input type="range" id="volChord" min="0" max="1" step="0.1" value="0.3">
    </div>

    <div class="status-display">
        <div class="current-note" id="noteDisplay">æº–å‚™é–‹å§‹</div>
        <div class="current-action" id="actionDisplay">è«‹æŒ‰ä¸‹æ’­æ”¾</div>
    </div>

    <div class="action-area">
        <button class="play-btn" id="playBtn" onclick="togglePlay()">â–¶ é–‹å§‹ç·´ç¿’</button>
        <button class="play-btn stop-btn" id="stopBtn" onclick="stopAudio()">â¹ åœæ­¢</button>
    </div>

<script>
    // --- éŸ³è¨Šå¼•æ“ (Web Audio API) ---
    let audioCtx;
    let isPlaying = false;
    let timeouts = [];
    let currentOscillators = [];

    const notes = ['C', 'C#', 'D', 'D#', 'E', 'F', 'F#', 'G', 'G#', 'A', 'A#', 'B'];
    
    // åˆå§‹åŒ–é¸å–®
    function initSelects() {
        const startSel = document.getElementById('startNote');
        const endSel = document.getElementById('endNote');
        let options = [];
        
        for(let oct=2; oct<=5; oct++) {
            notes.forEach(n => {
                options.push(`${n}${oct}`);
            });
        }
        
        options.forEach(n => {
            startSel.add(new Option(n, n));
            endSel.add(new Option(n, n));
        });

        // é è¨­å€¼
        startSel.value = 'A3';
        endSel.value = 'G4';
    }

    // å–å¾—é »ç‡
    function getFreq(noteName) {
        if(!noteName) return 440;
        const note = noteName.slice(0, -1);
        const octave = parseInt(noteName.slice(-1));
        const semitone = notes.indexOf(note);
        const midi = semitone + (octave + 1) * 12;
        return 440 * Math.pow(2, (midi - 69) / 12);
    }

    // ç”Ÿæˆé‹¼ç´éŸ³è‰²
    function playPianoTone(freq, startTime, duration, vol, isChord) {
        if (!audioCtx) return;
        const gainNode = audioCtx.createGain();
        gainNode.connect(audioCtx.destination);
        
        // éŸ³é‡åŒ…çµ¡ (ADSR)
        const now = startTime;
        gainNode.gain.setValueAtTime(0, now);
        gainNode.gain.linearRampToValueAtTime(vol, now + 0.02); // Attack
        gainNode.gain.exponentialRampToValueAtTime(0.01, now + duration); // Decay

        // åˆæˆéŸ³è‰² (åŸºé » + æ³›éŸ³)
        const harmonics = isChord ? [1, 2, 3] : [1, 2, 3, 4];
        const amps = isChord ? [1.0, 0.4, 0.2] : [1.0, 0.5, 0.2, 0.1];

        harmonics.forEach((h, i) => {
            const osc = audioCtx.createOscillator();
            osc.type = isChord ? 'triangle' : 'sine'; // å’Œå¼¦ç”¨ä¸‰è§’æ³¢å¢åŠ åšåº¦
            osc.frequency.value = freq * h;
            osc.connect(gainNode);
            osc.start(now);
            osc.stop(now + duration);
            currentOscillators.push(osc);
        });
    }

    // æ’­æ”¾é‚è¼¯
    let currentMode = 'liptrill';
    
    function setMode(mode) {
        currentMode = mode;
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
        event.target.classList.add('active');
        
        // è‡ªå‹•èª¿æ•´é è¨­éŸ³åŸŸ
        if(mode === 'liptrill') { 
            document.getElementById('startNote').value = 'A3'; 
            document.getElementById('endNote').value = 'C#4'; 
        } else if(mode === 'expansion') { 
            document.getElementById('startNote').value = 'A3'; 
            document.getElementById('endNote').value = 'G4'; 
        } else {
            document.getElementById('startNote').value = 'C3'; 
            document.getElementById('endNote').value = 'G4'; 
        }
        stopAudio();
    }

    function updateDisplay() {
        document.getElementById('speedVal').innerText = document.getElementById('speed').value;
    }

    function togglePlay() {
        if (isPlaying) {
            stopAudio();
        } else {
            startExercise();
        }
    }

    function stopAudio() {
        isPlaying = false;
        timeouts.forEach(t => clearTimeout(t));
        timeouts = [];
        currentOscillators.forEach(osc => {
            try { osc.stop(); } catch(e){}
        });
        currentOscillators = [];
        if(audioCtx) audioCtx.suspend();
        
        document.getElementById('playBtn').style.display = 'inline-block';
        document.getElementById('stopBtn').style.display = 'none';
        document.getElementById('noteDisplay').innerText = "æº–å‚™å°±ç·’";
        document.getElementById('actionDisplay').innerText = "æŒ‰ä¸‹æ’­æ”¾é–‹å§‹";
    }

    async function startExercise() {
        // åˆå§‹åŒ– AudioContext (å¿…é ˆåœ¨ç”¨æˆ¶é»æ“Šå¾Œ)
        if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        if (audioCtx.state === 'suspended') await audioCtx.resume();

        isPlaying = true;
        document.getElementById('playBtn').style.display = 'none';
        document.getElementById('stopBtn').style.display = 'inline-block';

        // è®€å–åƒæ•¸
        const startNote = document.getElementById('startNote').value;
        const endNote = document.getElementById('endNote').value;
        const speed = parseFloat(document.getElementById('speed').value);
        const volMelody = parseFloat(document.getElementById('volMelody').value);
        const volChord = parseFloat(document.getElementById('volChord').value);
        
        const beatTime = 0.4 / speed;

        // ç”Ÿæˆæ ¹éŸ³åºåˆ— (Chromatics)
        const allOpts = Array.from(document.getElementById('startNote').options).map(o => o.value);
        const sIdx = allOpts.indexOf(startNote);
        const eIdx = allOpts.indexOf(endNote);
        
        let roots = [];
        // ä¸Šå‡
        for(let i=sIdx; i<=eIdx; i++) roots.push(allOpts[i]);
        // ä¸‹é™ (å¾æœ€é«˜éŸ³çš„å‰ä¸€å€‹é–‹å§‹)
        for(let i=eIdx-1; i>=0; i--) roots.push(allOpts[i]); // ç›´åˆ° A2 (åˆ—è¡¨é ­)
        // ä¿®æ­£ï¼šå¦‚æœ startNote å¾ˆé«˜ï¼Œä¸‹é™è¦é™åˆ°æ›´ä½ï¼Œé€™è£¡ç°¡åŒ–ç‚ºé™å› A2
        // ç‚ºç¬¦åˆä¹‹å‰çš„é‚è¼¯ï¼Œæˆ‘å€‘è®“ä¸‹é™æ®µç›´æ¥é™åˆ°åº• (Index 0)
        
        let timeline = 0; // ç•¶å‰æ™‚é–“æŒ‡é‡

        // å®šç¾©æ¨¡å¼
        let intervals, totalBeats;
        if(currentMode === 'liptrill') {
            intervals = [0, 4, 7, 4, 0]; // 5 notes
            totalBeats = 6;
        } else if(currentMode === 'expansion') {
            intervals = [0, 2, 4, 5, 7, 5, 4, 2, 0]; // 9 notes
            totalBeats = 10;
        } else {
            intervals = [0, 12, 0]; // 3 notes
            totalBeats = 4;
        }

        // æ’ç¨‹è¿´åœˆ
        roots.forEach((rootName, idx) => {
            const rootFreq = getFreq(rootName);
            const startTime = audioCtx.currentTime + timeline + 0.1; // åŠ ä¸€é»ç·©è¡

            // 1. UI æ›´æ–°æ’ç¨‹ (ä½¿ç”¨ setTimeout)
            let tId = setTimeout(() => {
                document.getElementById('noteDisplay').innerText = rootName;
                document.getElementById('actionDisplay').innerText = (idx < roots.length/2) ? "â¬† ä¸Šå‡ä¸­..." : "â¬‡ ä¸‹é™ä¸­...";
                if(idx === roots.length -1) setTimeout(stopAudio, beatTime * totalBeats * 1000);
            }, timeline * 1000);
            timeouts.push(tId);

            // 2. å·¦æ‰‹ä¼´å¥ (é•·å’Œå¼¦)
            // å¤§ä¸‰å’Œå¼¦: Root, Major 3rd (4 semitones), Perfect 5th (7 semitones)
            const chordNotes = [0, 4, 7];
            chordNotes.forEach(semi => {
                const cf = rootFreq * Math.pow(2, semi/12);
                playPianoTone(cf, startTime, beatTime * totalBeats, volChord * 0.5, true); 
                // volChord * 0.5 é¿å…å’Œå¼¦å¤ªæ¶æˆ²
            });

            // 3. å³æ‰‹å°å¼• (æ—‹å¾‹)
            intervals.forEach((semi, i) => {
                const noteTime = startTime + (i * beatTime);
                const noteFreq = rootFreq * Math.pow(2, semi/12);
                playPianoTone(noteFreq, noteTime, beatTime, volMelody, false);
            });

            // 4. å¸æ°£æ‹ (è¦–è¦ºæç¤º)
            let breathTime = startTime + (intervals.length * beatTime);
            let tIdBreath = setTimeout(() => {
                document.getElementById('actionDisplay').innerText = "ğŸ˜¤ å¸æ°£ / æ”¾é¬†";
            }, (timeline + intervals.length * beatTime) * 1000);
            timeouts.push(tIdBreath);

            // æ›´æ–°æ™‚é–“è»¸
            timeline += (beatTime * totalBeats);
        });
    }

    initSelects();
</script>

</body>
</html>
